[
    {
        "id": "86c1cce0024c0f35",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "ccda7495396542c2",
        "type": "mqtt-broker",
        "name": "IDPASS",
        "broker": "broker.emqx.io",
        "port": "1883",
        "tls": "a695a59681baef74",
        "clientid": "nodered-render-pm",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": false,
        "autoUnsubscribe": false,
        "birthTopic": "air/pms5003",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "af94c5541ac7ab67",
        "type": "ui_group",
        "name": "Air Quality",
        "tab": "390f832b29e3cb21",
        "order": 1,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "2cfe40492fdff9da",
        "type": "ui_group",
        "name": "Details",
        "tab": "390f832b29e3cb21",
        "order": 1,
        "disp": true,
        "width": 6,
        "collapse": false,
        "className": ""
    },
    {
        "id": "390f832b29e3cb21",
        "type": "ui_tab",
        "name": "PM Monitor",
        "icon": "dashboard",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "c6b6da4cf10a9553",
        "type": "global-config",
        "env": []
    },
    {
        "id": "ca2b0843ed566e37",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#0094CE",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#1bbfff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#0094ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "a695a59681baef74",
        "type": "tls-config",
        "name": "hivemq-tls",
        "cert": "",
        "key": "",
        "ca": "",
        "certname": "",
        "keyname": "",
        "caname": "",
        "servername": "",
        "verifyservercert": false,
        "alpnprotocol": ""
    },
    {
        "id": "d34524d795ea2586",
        "type": "gauth",
        "name": "Unknown"
    },
    {
        "id": "d087e1ec488e1435",
        "type": "gauth",
        "name": "esp32-service@esp32pm25data.iam.gserviceaccount.com"
    },
    {
        "id": "64991135615702ea",
        "type": "gauth",
        "name": "esp32-service@esp32pm25data.iam.gserviceaccount.com"
    },
    {
        "id": "207f7298c6cf4d74",
        "type": "gauth",
        "name": "Unknown"
    },
    {
        "id": "47449cdc6b79ea00",
        "type": "gauth",
        "name": "esp32-service@esp32pm25data.iam.gserviceaccount.com"
    },
    {
        "id": "f8bd1a80d6eb3025",
        "type": "mqtt in",
        "z": "86c1cce0024c0f35",
        "name": "",
        "topic": "air/pms5003",
        "qos": "1",
        "datatype": "auto-detect",
        "broker": "ccda7495396542c2",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 380,
        "wires": [
            [
                "066526f5b7e012cd",
                "cfcfec3e8bb9a0af"
            ]
        ]
    },
    {
        "id": "6c9be860ecdd4a01",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 1",
        "func": "// ===== ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ =====\nvar pm1  = Number(msg.payload.PM1);\nvar pm25 = Number(msg.payload.PM25);\nvar pm10 = Number(msg.payload.PM10);\n\n// ===== ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á =====\nif (pm1 > 200 || pm25 > 200 || pm10 > 200) {\n    node.warn(\"Sensor error > 200\");\n    return null;\n}\n\n// ===== ‡∏Å‡∏£‡∏≠‡∏á Spike =====\nvar last = context.get(\"lastPM25\");\n\nif (last !== undefined && Math.abs(pm25 - last) > 50) {\n    node.warn(\"Spike detected - rejected\");\n    return null;   // ‡∏ï‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö\n}\n\ncontext.set(\"lastPM25\", pm25);\n\n// ===== ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å =====\nvar chartMsgs = [\n    { topic: \"PM1\", payload: pm1 },\n    { topic: \"PM2.5\", payload: pm25 },\n    { topic: \"PM10\", payload: pm10 }\n];\n\nvar gaugeMsg = { payload: pm25 };\nvar statusMsg = { payload: pm25 };\n\n// üî¥ ‡πÄ‡∏û‡∏¥‡πà‡∏° output ‡∏ó‡∏µ‡πà 4 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ sheet\nvar sheetMsg = {\n    payload: {\n        PM1: pm1,\n        PM25: pm25,\n        PM10: pm10\n    }\n};\n\nreturn [\n    chartMsgs,\n    gaugeMsg,\n    statusMsg,\n    sheetMsg\n];",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 380,
        "wires": [
            [],
            [
                "6001036b70836858"
            ],
            [
                "d89bb7ed9400451f",
                "1e6f40a18f1c4bc5",
                "99b2104e8511d5d6",
                "20648248bf79c6d7"
            ]
        ]
    },
    {
        "id": "07abfef8314e8097",
        "type": "ui_template",
        "z": "86c1cce0024c0f35",
        "group": "2cfe40492fdff9da",
        "name": "",
        "order": 5,
        "width": 0,
        "height": 0,
        "format": "<div style=\"padding: 10px;\">\n    <h4 style=\"text-align:center; margin-bottom:8px;\">\n        ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ù‡∏∏‡πà‡∏ô PM2.5\n    </h4>\n\n    <table style=\"\n        width:100%;\n        border-collapse: collapse;\n        text-align: center;\n        font-size: 14px;\n    \">\n        <tr style=\"background:#f2f2f2;\">\n            <th style=\"border:1px solid #ccc; padding:6px;\">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>\n            <th style=\"border:1px solid #ccc; padding:6px;\">‡∏Ñ‡πà‡∏≤ PM2.5 (¬µg/m¬≥)</th>\n            <th style=\"border:1px solid #ccc; padding:6px;\">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</th>\n        </tr>\n\n        <tr style=\"background:#2ecc71; color:white;\">\n            <td style=\"border:1px solid #ccc;\">üü¢</td>\n            <td style=\"border:1px solid #ccc;\">0 ‚Äì 25</td>\n            <td style=\"border:1px solid #ccc;\">‡∏î‡∏µ‡∏°‡∏≤‡∏Å</td>\n        </tr>\n\n        <tr style=\"background:#f1c40f;\">\n            <td style=\"border:1px solid #ccc;\">üü°</td>\n            <td style=\"border:1px solid #ccc;\">26 ‚Äì 50</td>\n            <td style=\"border:1px solid #ccc;\">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</td>\n        </tr>\n\n        <tr style=\"background:#e67e22; color:white;\">\n            <td style=\"border:1px solid #ccc;\">üü†</td>\n            <td style=\"border:1px solid #ccc;\">51 ‚Äì 100</td>\n            <td style=\"border:1px solid #ccc;\">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</td>\n        </tr>\n\n        <tr style=\"background:#e74c3c; color:white;\">\n            <td style=\"border:1px solid #ccc;\">üî¥</td>\n            <td style=\"border:1px solid #ccc;\">‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 100</td>\n            <td style=\"border:1px solid #ccc;\">‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</td>\n        </tr>\n    </table>\n\n    <div style=\"font-size:12px; margin-top:6px; text-align:center;\">\n        ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® WHO / ‡∏Å‡∏£‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏°‡∏•‡∏û‡∏¥‡∏©\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 640,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "ed7e3c56ba2740b4",
        "type": "inject",
        "z": "86c1cce0024c0f35",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "reset_hourly",
        "payloadType": "str",
        "x": 700,
        "y": 180,
        "wires": [
            [
                "d5f03abc92e5b379",
                "de82f3cc5d5aba65"
            ]
        ]
    },
    {
        "id": "6001036b70836858",
        "type": "ui_gauge",
        "z": "86c1cce0024c0f35",
        "name": "",
        "group": "af94c5541ac7ab67",
        "order": 1,
        "width": "0",
        "height": "0",
        "gtype": "gage",
        "title": "PM2.5 Realtime",
        "label": "Unit",
        "format": "{{value}} ¬µg/m¬≥",
        "min": 0,
        "max": "90",
        "colors": [
            "#4edf58",
            "#f3f312",
            "#ca3838"
        ],
        "seg1": "25",
        "seg2": "50",
        "diff": false,
        "className": "",
        "x": 980,
        "y": 340,
        "wires": []
    },
    {
        "id": "7a9901166c5bf714",
        "type": "ui_chart",
        "z": "86c1cce0024c0f35",
        "name": "",
        "group": "af94c5541ac7ab67",
        "order": 4,
        "width": 0,
        "height": 0,
        "label": "24H Summary",
        "chartType": "line",
        "legend": "true",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": true,
        "ymin": "0",
        "ymax": "100",
        "removeOlder": "24",
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#11ff00",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 1320,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "966d6f940f8c460a",
        "type": "ui_template",
        "z": "86c1cce0024c0f35",
        "group": "af94c5541ac7ab67",
        "name": "EMOJI",
        "order": 2,
        "width": 0,
        "height": 0,
        "format": "<div style=\"\n    padding: 12px;\n    border-radius: 12px;\n    text-align: center;\n    color: white;\n    background-color: {{msg.payload.color}};\n\">\n    <div style=\"font-size: 32px; line-height: 1;\">\n        {{msg.payload.icon}}\n    </div>\n\n    <div style=\"font-size: 20px; font-weight: bold; margin-top: 4px;\">\n        PM2.5: {{msg.payload.pm25}} ¬µg/m¬≥\n    </div>\n\n    <div style=\"margin-top: 2px;\">\n        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{msg.payload.status}}\n    </div>\n\n    <div style=\"font-size: 12px; margin-top: 4px;\">\n        ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {{msg.payload.time}}\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 970,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "d89bb7ed9400451f",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 2",
        "func": "var pm25 = Number(msg.payload);\nvar status = \"\";\nvar color = \"\";\nvar icon = \"\";\n\nif (pm25 <= 25) {\n    status = \"‡∏î‡∏µ‡∏°‡∏≤‡∏Å\";\n    color = \"#2ecc71\";\n    icon = \"üü¢üòä\";\n} else if (pm25 <= 50) {\n    status = \"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á\";\n    color = \"#f1c40f\";\n    icon = \"üü°üôÇ\";\n} else if (pm25 <= 100) {\n    status = \"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û\";\n    color = \"#e67e22\";\n    icon = \"üü†üò∑\";\n} else {\n    status = \"‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢\";\n    color = \"#e74c3c\";\n    icon = \"üî¥‚ò†Ô∏è\";\n}\n\nmsg.payload = {\n    pm25: pm25,\n    status: status,\n    color: color,\n    icon: icon,\n    time: new Date().toLocaleString(\"th-TH\")\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 400,
        "wires": [
            [
                "966d6f940f8c460a"
            ]
        ]
    },
    {
        "id": "1e6f40a18f1c4bc5",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 3",
        "func": "var pm25 = Number(msg.payload);\n\nvar advice = \"\";\nvar color = \"\";\nvar icon = \"\";\n\nif (pm25 <= 25) {\n    advice = \"‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥\";\n    color = \"#2ecc71\";\n    icon = \"üèÉ‚Äç‚ôÇÔ∏èüåø\";\n} else if (pm25 <= 50) {\n    advice = \"‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£\";\n    color = \"#f1c40f\";\n    icon = \"üòê\";\n} else if (pm25 <= 100) {\n    advice = \"‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á\";\n    color = \"#e67e22\";\n    icon = \"üò∑\";\n} else {\n    advice = \"‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á\";\n    color = \"#e74c3c\";\n    icon = \"üö®\";\n}\n\nmsg.payload = {\n    pm25: pm25,\n    advice: advice,\n    color: color,\n    icon: icon\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 440,
        "wires": [
            [
                "0f5dfeb4e373b9f7"
            ]
        ]
    },
    {
        "id": "0f5dfeb4e373b9f7",
        "type": "ui_template",
        "z": "86c1cce0024c0f35",
        "group": "af94c5541ac7ab67",
        "name": "Health",
        "order": 3,
        "width": 0,
        "height": 0,
        "format": "<div style=\"\n    padding:10px;\n    border-radius:12px;\n    text-align:center;\n    background-color: {{msg.payload.color}};\n    color:white;\n    overflow:hidden;\n\">\n    <div style=\"font-size:26px; line-height:1;\">\n        {{msg.payload.icon}}\n    </div>\n\n    <div style=\"font-size:16px; font-weight:bold; margin-top:4px;\">\n        ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û\n    </div>\n\n    <div style=\"font-size:14px; margin-top:2px;\">\n        {{msg.payload.advice}}\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 970,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "99b2104e8511d5d6",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 4",
        "func": "var pm25 = Number(msg.payload);\n\nvar max = context.get(\"daily_max\") ?? pm25;\nvar min = context.get(\"daily_min\") ?? pm25;\nvar sum = context.get(\"daily_sum\") ?? 0;\nvar count = context.get(\"daily_count\") ?? 0;\n\nif (pm25 > max) max = pm25;\nif (pm25 < min) min = pm25;\n\nsum += pm25;\ncount += 1;\n\ncontext.set(\"daily_max\", max);\ncontext.set(\"daily_min\", min);\ncontext.set(\"daily_sum\", sum);\ncontext.set(\"daily_count\", count);\n\nmsg.payload = {\n    max: max,\n    min: min,\n    avg: (sum / count).toFixed(1)\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 480,
        "wires": [
            [
                "b473d0e706690651"
            ]
        ]
    },
    {
        "id": "b473d0e706690651",
        "type": "ui_template",
        "z": "86c1cce0024c0f35",
        "group": "af94c5541ac7ab67",
        "name": "",
        "order": 4,
        "width": 0,
        "height": 0,
        "format": "<div style=\"\n    padding:12px;\n    border-radius:12px;\n    background:#ecf0f1;\n    text-align:center;\n\">\n    <b>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (PM2.5)</b><br>\n    ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: {{msg.payload.max}} ¬µg/m¬≥<br>\n    ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: {{msg.payload.min}} ¬µg/m¬≥<br>\n    ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: {{msg.payload.avg}} ¬µg/m¬≥\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1220,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "20648248bf79c6d7",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 5",
        "func": "var pm25 = Number(msg.payload);\nvar last = context.get(\"trend_lastPM25\");\n\nvar trend = \"‚ûñ ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà\";\nif (last !== undefined) {\n    if (pm25 > last) trend = \"‚¨ÜÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô\";\n    else if (pm25 < last) trend = \"‚¨áÔ∏è ‡∏•‡∏î‡∏•‡∏á\";\n}\n\ncontext.set(\"trend_lastPM25\", pm25);\n\nmsg.payload = {\n    trend: trend,\n    value: pm25\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 520,
        "wires": [
            [
                "7f82a9f9fdbb2cbe"
            ]
        ]
    },
    {
        "id": "7f82a9f9fdbb2cbe",
        "type": "ui_template",
        "z": "86c1cce0024c0f35",
        "group": "2cfe40492fdff9da",
        "name": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "format": "<div style=\"\n    padding:10px;\n    border-radius:10px;\n    background:#fdfefe;\n    text-align:center;\n\">\n    <b>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡πà‡∏≤ PM2.5</b><br>\n    {{msg.payload.trend}}\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 980,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "d5f03abc92e5b379",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 6",
        "func": "// ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á\ncontext.set(\"hourData\", {});\ncontext.set(\"lastHour\", null);\n\n// ‡∏™‡∏±‡πà‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü Hourly Summary\nmsg.ui_control = { clear: true };\n\n// ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á payload\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 180,
        "wires": [
            [
                "7a9901166c5bf714"
            ]
        ]
    },
    {
        "id": "de82f3cc5d5aba65",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 7",
        "func": "context.set(\"daily_max\", null);\ncontext.set(\"daily_min\", null);\ncontext.set(\"daily_sum\", 0);\ncontext.set(\"daily_count\", 0);\n\nmsg.payload = {\n    max: \"-\",\n    min: \"-\",\n    avg: \"-\"\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 240,
        "wires": [
            [
                "b473d0e706690651"
            ]
        ]
    },
    {
        "id": "045de5d3636534cd",
        "type": "ui_chart",
        "z": "86c1cce0024c0f35",
        "name": "",
        "group": "2cfe40492fdff9da",
        "order": 2,
        "width": 0,
        "height": 0,
        "label": "30 Day Summary",
        "chartType": "line",
        "legend": "true",
        "xformat": "D/M",
        "interpolate": "linear",
        "nodata": "",
        "dot": true,
        "ymin": "0",
        "ymax": "100",
        "removeOlder": "30",
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#1f77b4",
            "#aec7e8",
            "#ff7f0e",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 1310,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "207e080bf12fad03",
        "type": "GSheet",
        "z": "86c1cce0024c0f35",
        "creds": "47449cdc6b79ea00",
        "method": "append",
        "action": "",
        "sheet": "1aZN_eEUDGyOsjyslA42A-W3EbSq5chobLTYqEGifaf4",
        "cells": "raw_data!A:D",
        "flatten": false,
        "name": "raw_data",
        "x": 640,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "cfcfec3e8bb9a0af",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 8",
        "func": "let now = new Date().toISOString();\nlet data = msg.payload;\n\nlet pm1 = 0;\nlet pm25 = 0;\nlet pm10 = 0;\n\n// ===== ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô JSON object =====\nif (typeof data === \"object\") {\n    pm1 = Number(data.PM1) || 0;\n    pm25 = Number(data.PM25) || 0;\n    pm10 = Number(data.PM10) || 0;\n}\n\n// ===== ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô string =====\nelse if (typeof data === \"string\") {\n\n    let matchPM1 = data.match(/PM1:(\\d+)/);\n    let matchPM25 = data.match(/PM2\\.5:(\\d+)/);\n    let matchPM10 = data.match(/PM10:(\\d+)/);\n\n    if (matchPM1) pm1 = Number(matchPM1[1]);\n    if (matchPM25) pm25 = Number(matchPM25[1]);\n    if (matchPM10) pm10 = Number(matchPM10[1]);\n}\n\nmsg.payload = [\n    [now, pm1, pm25, pm10]\n];\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 560,
        "wires": [
            [
                "207e080bf12fad03"
            ]
        ]
    },
    {
        "id": "64dabc163a8865d7",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "Format 24H Chart",
        "func": "let rows = msg.payload || [];\n\n// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô Header)\nif (!Array.isArray(rows) || rows.length < 2) {\n    node.status({fill:\"yellow\", shape:\"ring\", text:\"No data in sheet\"});\n    // ‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Chart ‡πÑ‡∏°‡πà Error\n    msg.payload = [{ series: [\"PM1\", \"PM2.5\", \"PM10\"], data: [[], [], []], labels: [] }];\n    return msg; \n}\n\n// ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö\nlet dataRows = rows.slice(1).filter(r => Array.isArray(r) && r.length >= 4);\n\n// ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤\ndataRows.sort((a, b) => new Date(a[0]).getTime() - new Date(b[0]).getTime());\n\n// ‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (24 ‡∏´‡∏£‡∏∑‡∏≠ 30 ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏´‡∏ô‡∏î)\nlet limit = (node.name === \"Format 24H Chart\") ? -24 : -30;\ndataRows = dataRows.slice(limit);\n\nlet labels = [];\nlet pm1 = [];\nlet pm25 = [];\nlet pm10 = [];\n\ndataRows.forEach(r => {\n    labels.push(new Date(r[0]).toLocaleTimeString(\"th-TH\", {hour: '2-digit', minute:'2-digit'}));\n    pm1.push(Number(r[1]) || 0);\n    pm25.push(Number(r[2]) || 0);\n    pm10.push(Number(r[3]) || 0);\n});\n\nmsg.payload = [{\n    series: [\"PM1\", \"PM2.5\", \"PM10\"],\n    data: [pm1, pm25, pm10],\n    labels: labels\n}];\n\nnode.status({fill:\"green\", shape:\"dot\", text:\"Data updated\"});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1130,
        "y": 300,
        "wires": [
            [
                "7a9901166c5bf714"
            ]
        ]
    },
    {
        "id": "bece90e5dd28be29",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "Format 30D Chart",
        "func": "let rows = msg.payload || [];\n\n// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô Header)\nif (!Array.isArray(rows) || rows.length < 2) {\n    node.status({fill:\"yellow\", shape:\"ring\", text:\"No data in sheet\"});\n    // ‡∏™‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Chart ‡πÑ‡∏°‡πà Error\n    msg.payload = [{ series: [\"PM1\", \"PM2.5\", \"PM10\"], data: [[], [], []], labels: [] }];\n    return msg; \n}\n\n// ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö\nlet dataRows = rows.slice(1).filter(r => Array.isArray(r) && r.length >= 4);\n\n// ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤\ndataRows.sort((a, b) => new Date(a[0]).getTime() - new Date(b[0]).getTime());\n\n// ‡∏ï‡∏±‡∏î‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (24 ‡∏´‡∏£‡∏∑‡∏≠ 30 ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏´‡∏ô‡∏î)\nlet limit = (node.name === \"Format 30D Chart\") ? -24 : -30;\ndataRows = dataRows.slice(limit);\n\nlet labels = [];\nlet pm1 = [];\nlet pm25 = [];\nlet pm10 = [];\n\ndataRows.forEach(r => {\n    labels.push(new Date(r[0]).toLocaleTimeString(\"th-TH\", {hour: '2-digit', minute:'2-digit'}));\n    pm1.push(Number(r[1]) || 0);\n    pm25.push(Number(r[2]) || 0);\n    pm10.push(Number(r[3]) || 0);\n});\n\nmsg.payload = [{\n    series: [\"PM1\", \"PM2.5\", \"PM10\"],\n    data: [pm1, pm25, pm10],\n    labels: labels\n}];\n\nnode.status({fill:\"green\", shape:\"dot\", text:\"Data updated\"});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 140,
        "wires": [
            [
                "045de5d3636534cd"
            ]
        ]
    },
    {
        "id": "3b9f64afeeb519e7",
        "type": "inject",
        "z": "86c1cce0024c0f35",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 830,
        "y": 120,
        "wires": [
            [
                "bece90e5dd28be29"
            ]
        ]
    },
    {
        "id": "e4a1620bdde9570c",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 10",
        "func": "if (!msg.payload || msg.payload === \"undefined\") {\n    return null;\n}\n\nif (!Array.isArray(msg.payload)) {\n    return null;\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 300,
        "wires": [
            [
                "64dabc163a8865d7"
            ]
        ]
    },
    {
        "id": "066526f5b7e012cd",
        "type": "switch",
        "z": "86c1cce0024c0f35",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 330,
        "y": 380,
        "wires": [
            [
                "07abfef8314e8097",
                "6c9be860ecdd4a01"
            ]
        ]
    },
    {
        "id": "4925930b5d93b847",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "Sheet Hourly Average",
        "func": "var rows = msg.payload;\n\nif (!Array.isArray(rows)) return null;\nif (rows.length < 2) return null; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n\nrows.shift(); // ‡∏•‡∏ö header\n\nvar oneHourAgo = Date.now() - (60 * 60 * 1000);\n\nvar sum1 = 0, sum25 = 0, sum10 = 0, count = 0;\n\nrows.forEach(r => {\n    if (!r[0]) return;\n\n    var t = new Date(r[0]).getTime();\n    if (!isNaN(t) && t >= oneHourAgo) {\n        sum1 += Number(r[1]) || 0;\n        sum25 += Number(r[2]) || 0;\n        sum10 += Number(r[3]) || 0;\n        count++;\n    }\n});\n\nif (count === 0) return null;\n\nmsg.payload = [\n    [\n        new Date().toISOString(),\n        (sum1 / count).toFixed(1),\n        (sum25 / count).toFixed(1),\n        (sum10 / count).toFixed(1)\n    ]\n];\nnode.warn(JSON.stringify(msg.payload));\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 660,
        "wires": [
            [
                "6ae01ecdfe7a9dc9"
            ]
        ]
    },
    {
        "id": "3de50718be1a22ed",
        "type": "GSheet",
        "z": "86c1cce0024c0f35",
        "creds": "d087e1ec488e1435",
        "method": "get",
        "action": "",
        "sheet": "1aZN_eEUDGyOsjyslA42A-W3EbSq5chobLTYqEGifaf4",
        "cells": "raw_data!A:D",
        "flatten": false,
        "name": "Get raw_data",
        "x": 360,
        "y": 660,
        "wires": [
            [
                "42e03ce005c0a9d6"
            ]
        ]
    },
    {
        "id": "331be8fbb8b76196",
        "type": "inject",
        "z": "86c1cce0024c0f35",
        "name": "Hourly Trigger",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "3600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 620,
        "wires": [
            [
                "3de50718be1a22ed"
            ]
        ]
    },
    {
        "id": "42e03ce005c0a9d6",
        "type": "function",
        "z": "86c1cce0024c0f35",
        "name": "function 9",
        "func": "if (!msg.payload || msg.payload === \"undefined\") {\n    return null;\n}\n\nif (!Array.isArray(msg.payload)) {\n    return null;\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 660,
        "wires": [
            [
                "4925930b5d93b847"
            ]
        ]
    },
    {
        "id": "f809986c85ea59ab",
        "type": "inject",
        "z": "86c1cce0024c0f35",
        "name": "reset hourly",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 490,
        "y": 260,
        "wires": [
            [
                "6f7a590c0341f347"
            ]
        ]
    },
    {
        "id": "6ae01ecdfe7a9dc9",
        "type": "GSheet",
        "z": "86c1cce0024c0f35",
        "creds": "64991135615702ea",
        "method": "append",
        "action": "",
        "sheet": "1aZN_eEUDGyOsjyslA42A-W3EbSq5chobLTYqEGifaf4",
        "cells": "hourly_summary!A:D",
        "flatten": false,
        "name": "hourly_summary",
        "x": 1020,
        "y": 660,
        "wires": [
            [
                "7a9901166c5bf714"
            ]
        ]
    },
    {
        "id": "6f7a590c0341f347",
        "type": "GSheet",
        "z": "86c1cce0024c0f35",
        "creds": "47449cdc6b79ea00",
        "method": "get",
        "action": "",
        "sheet": "1aZN_eEUDGyOsjyslA42A-W3EbSq5chobLTYqEGifaf4",
        "cells": "hourly_summary!A:D",
        "flatten": false,
        "name": "Get hourly_summary",
        "x": 740,
        "y": 300,
        "wires": [
            [
                "bece90e5dd28be29",
                "e4a1620bdde9570c"
            ]
        ]
    }
]